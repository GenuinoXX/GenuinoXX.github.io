<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa Baidu</title>
  <script src="https://api.map.baidu.com/api?v=3.0&ak=1Vkcxd0Q6iomR9TI8zNfzhwXWdeBYAd2"></script>
  <script src="https://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      const boundaryParam = params.get("boundary");
      let boundaryPoints = [];
      if (boundaryParam) {
        try {
          boundaryPoints = JSON.parse(decodeURIComponent(boundaryParam));
        } catch (e) {
          console.error("Error parsing boundary:", e);
        }
      }
      return {
        lat: parseFloat(params.get("lat")) || 40.4168,
        lng: parseFloat(params.get("lng")) || -3.7038,
        zoom: parseInt(params.get("zoom")) || 10,
        boundary: boundaryPoints,
        tourist_destination: params.get("tourist_destination") || "comunidaddemadrid",
        tourist_type: params.get("tourist_type") || ""
      };
    }

    const params = getQueryParams();

    async function fetchPOIs(dest, lat, lng, zoom, boundary, type) {
      let api = type
        ? `https://api.inventrip.com/v100/map-poi-geojson?api_key=C0munid%40dDeM%40dr%21d&tourist_destination=${dest}&language=en&show_hidden=false&tourist_type_or=${type}`
        : `https://api.inventrip.com/v100/map-poi-geojson?api_key=C0munid%40dDeM%40dr%21d&tourist_destination=${dest}&language=en&show_hidden=false`;

      try {
        const res = await fetch(api);
        const data = await res.json();
        const pois = data.features.map(f => ({
          lat: f.geometry.coordinates[1],
          lng: f.geometry.coordinates[0],
          name: f.properties.name,
          icon: f.properties.icon_image,
          zoom: f.properties.zoom_level || 10
        }));
        initMap(pois, lat, lng, zoom, boundary);
      } catch (err) {
        console.error("Error al obtener POIs:", err);
      }
    }

    function initMap(pois, centerLat, centerLng, zoom, boundary) {
      const map = new BMap.Map("map");
      const center = new BMap.Point(centerLng, centerLat);
      map.centerAndZoom(center, zoom);
      map.setMinZoom(zoom);
      map.enableScrollWheelZoom();

      const markers = [];
      const labelMap = new Map();

      pois.forEach(poi => {
        const point = new BMap.Point(poi.lng, poi.lat);
        const icon = new BMap.Icon(poi.icon, new BMap.Size(32, 32));
        const marker = new BMap.Marker(point, { icon });
        marker.setTitle(poi.name);

        const label = new BMap.Label(poi.name, {
          position: point,
          offset: new BMap.Size(-32, 11)
        });

        label.setStyle({
          color: "#f60",
          fontSize: "14px",
          fontWeight: "bold",
          backgroundColor: "transparent",
          border: "none",
          textAlign: "center",
          lineHeight: "16px",
          width: "64px",
          whiteSpace: "normal"
        });

        map.addOverlay(label);
        labelMap.set(marker, label);

        marker.addEventListener("click", () => {
          const message = {
            type: "openDescription",
            name: poi.name
          };
          if (window.WeixinJSBridge?.invoke) {
            WeixinJSBridge.invoke('postMessage', { data: [message] });
          }
          if (window.parent) {
            window.parent.postMessage({ data: [message] }, "*");
          }
        });

        markers.push(marker);
      });

      const clusterer = new BMapLib.MarkerClusterer(map, {
        markers,
        gridSize: 80,
        maxZoom: 15,
        styles: [{
          url: "https://api.map.baidu.com/library/MarkerClusterer/1.2/images/cluster.png",
          size: new BMap.Size(53, 52),
          textColor: "#fff",
          textSize: 14
        }]
      });

      function updateLabelVisibility() {
        const currentZoom = map.getZoom();
        for (const [marker, label] of labelMap.entries()) {
          currentZoom >= 13 ? label.show() : label.hide();
        }
      }

      map.addEventListener("zoomend", updateLabelVisibility);
      map.addEventListener("moveend", updateLabelVisibility);
      updateLabelVisibility();
    }

    fetchPOIs(
      params.tourist_destination,
      params.lat,
      params.lng,
      params.zoom,
      params.boundary,
      params.tourist_type || null
    );
  </script>
</body>
</html>